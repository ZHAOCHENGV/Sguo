# 战斗系统实现进度报告

## 📊 **当前完成度：50%** ⬆️ (+10%，上次 40%）

## ✅ **已完成的模块**

### **1. GAS伤害计算系统** ✅ 100%

#### 文件列表：
- `SG_DamageExecutionCalc.h/cpp` - 伤害计算执行类

#### 功能说明：
- ✅ 使用 Execution Calculation 计算伤害
- ✅ 支持从攻击者读取 AttackDamage 属性
- ✅ 支持通过 SetByCaller 设置伤害倍率（Tag: Data.Damage）
- ✅ 将最终伤害应用到 IncomingDamage 属性
- ✅ 详细的日志输出

#### 使用方式：
```cpp
// 在 GameplayEffect 蓝图中：
// 1. Duration Policy: Instant（瞬时效果）
// 2. Modifiers: 清空
// 3. Executions: 添加 SG_DamageExecutionCalc
// 4. 在技能中使用 SetByCaller 设置伤害倍率

FGameplayTag DamageTag = FGameplayTag::RequestGameplayTag(FName("Data.Damage"));
SpecHandle.Data->SetSetByCallerMagnitude(DamageTag, 1.0f); // 1.0 = 100%伤害
```

---

### **2. 攻击技能基类** ✅ 100%

#### 文件列表：
- `SG_GameplayAbility_Attack.h/cpp` - 攻击能力基类

#### 功能说明：
- ✅ 支持近战、远程、技能三种攻击类型
- ✅ 统一的攻击流程（动画→判定→伤害）
- ✅ 攻击动画蒙太奇支持
- ✅ 动画通知回调（AttackHit 触发判定）
- ✅ 自动查找范围内的敌方目标
- ✅ 应用伤害 GameplayEffect
- ✅ 蓝图事件：OnAttackHit

#### 攻击类型：
1. **近战攻击**（Melee）
   - 球形范围检测
   - 适用于步兵、骑兵

2. **远程攻击**（Ranged）
   - 射线检测
   - 适用于直线攻击（弩兵）

3. **技能攻击**（Skill）
   - 自定义判定逻辑
   - 由子类或蓝图实现

#### 使用方式：
```cpp
// 创建子类继承 USG_GameplayAbility_Attack
UCLASS()
class UGA_Infantry_Attack : public USG_GameplayAbility_Attack
{
    GENERATED_BODY()
public:
    UGA_Infantry_Attack()
    {
        AttackType = ESGAttackAbilityType::Melee;
        DamageMultiplier = 1.0f; // 100%伤害
    }
};

// 在蓝图中配置：
// - AttackMontage：攻击动画蒙太奇
// - DamageEffectClass：伤害 GE 类
// - DamageMultiplier：伤害倍率
```

---

### **3. 投射物系统** ✅ 100%

#### 文件列表：
- `SG_Projectile.h/cpp` - 投射物Actor

#### 功能说明：
- ✅ 支持直线飞行和抛物线飞行
- ✅ 碰撞检测和伤害应用
- ✅ 支持穿透攻击
- ✅ 自动销毁机制（生存时间）
- ✅ 蓝图事件：OnHitTarget

#### 飞行类型：
1. **直线飞行**（Linear）
   - 不受重力影响
   - 适用于弩箭、连弩战车

2. **抛物线飞行**（Parabolic）
   - 受重力影响
   - 适用于弓箭、投石车

#### 使用方式：
```cpp
// 生成投射物
ASG_Projectile* Projectile = GetWorld()->SpawnActor<ASG_Projectile>(
    ProjectileClass,
    SpawnLocation,
    SpawnRotation
);

// 初始化投射物
if (Projectile)
{
    FVector Direction = GetActorForwardVector();
    Projectile->InitializeProjectile(
        InstigatorASC,      // 攻击者的 ASC
        InstigatorFactionTag, // 攻击者的阵营标签
        Direction           // 飞行方向
    );
}

// 在蓝图中配置：
// - ProjectileType：飞行类型（Linear/Parabolic）
// - ProjectileSpeed：飞行速度
// - GravityScale：重力缩放（抛物线飞行）
// - bPenetrate：是否穿透
// - DamageEffectClass：伤害 GE 类
// - DamageMultiplier：伤害倍率
```

---

### **4. 单位数据表结构** ✅ 100%

#### 文件列表：
- `SG_UnitDataTable.h` - 单位数据表结构

#### 功能说明：
- ✅ DataTable 行结构定义
- ✅ 配置单位的所有基础属性
- ✅ 支持攻击类型配置
- ✅ 支持投射物配置
- ✅ 支持 AI 配置

#### 配置示例：
```
步兵配置：
- 生命值：500
- 攻击力：50
- 移动速度：400
- 攻击速度：1.5（攻速快）
- 攻击范围：150
- 攻击类型：近战

骑兵配置：
- 生命值：600
- 攻击力：70
- 移动速度：600（速度快）
- 攻击速度：1.2（攻速中）
- 攻击范围：150
- 攻击类型：近战

弓兵配置：
- 生命值：300
- 攻击力：40
- 移动速度：400
- 攻击速度：1.0（攻速中）
- 攻击范围：1000（远程）
- 攻击类型：远程抛物线
- 投射物类：BP_Projectile_Arrow
```

#### 使用方式：
1. **创建 DataTable 资产**
   - Content Browser → 右键 → Miscellaneous → Data Table
   - 选择 FSGUnitDataRow 作为行结构
   - 命名为 DT_UnitData

2. **添加配置行**
   - 打开 DataTable
   - 添加新行（行名称：Infantry_Basic）
   - 填写单位属性

3. **在代码中读取**
   ```cpp
   // 从 DataTable 读取单位数据
   FSGUnitDataRow* UnitData = UnitDataTable->FindRow<FSGUnitDataRow>(
       FName("Infantry_Basic"),
       TEXT("读取单位数据")
   );
   
   if (UnitData)
   {
       // 使用配置初始化单位
       InitializeAttributes(
           UnitData->BaseHealth,
           UnitData->BaseAttackDamage,
           UnitData->BaseMoveSpeed
       );
   }
   ```

---

### **5. 单位系统集成** ✅ 100% ⭐ 已完成

### **6. 蓝图父类创建** ✅ 100% ⭐ 新增

#### 文件列表：
- `SG_UnitsBase.h/cpp` - 单位基类（已修改）

#### 功能说明：
- ✅ DataTable 配置加载系统
- ✅ 攻击能力自动授予
- ✅ 攻击触发接口（供AI调用）
- ✅ 目标有效性检查
- ✅ 完整的代码注释和日志

#### 新增属性：
```cpp
// DataTable 配置
TObjectPtr<UDataTable> UnitDataTable;          // 单位数据表引用
FName UnitDataRowName;                         // 数据表行名称
bool bUseDataTable = false;                    // 是否使用数据表

// 攻击配置
TObjectPtr<UAnimMontage> AttackMontage;        // 攻击动画
TSubclassOf<AActor> ProjectileClass;          // 投射物类
FGameplayAbilitySpecHandle GrantedAttackAbilityHandle; // 已授予的攻击能力
```

#### 新增函数：
```cpp
// DataTable 加载
void LoadUnitDataFromTable();                  // 从DataTable加载配置

// 攻击系统
void GrantAttackAbility();                     // 授予攻击能力
bool PerformAttack();                          // 执行攻击（AI调用）
bool IsTargetValid() const;                    // 检查目标有效性
```

#### 工作流程：
```
BeginPlay()
  ↓
LoadUnitDataFromTable()  // 从DataTable读取配置
  ↓
GrantAttackAbility()     // 授予对应的攻击GA
  ↓
[AI循环]
  ↓
FindNearestTarget()      // 查找目标
  ↓
IsTargetValid()          // 检查目标有效
  ↓
PerformAttack()          // 触发攻击
```

#### 使用方式：
```cpp
// 在 Blueprint 中配置：
// 1. 设置 bUseDataTable = true
// 2. 设置 UnitDataTable = DT_UnitData
// 3. 设置 UnitDataRowName = "Infantry_Basic"
// 4. 运行时会自动加载配置并授予攻击能力

// 在 AI 中调用攻击：
if (UnitRef->IsTargetValid())
{
    bool bSuccess = UnitRef->PerformAttack();
}
```

---

### **6. 蓝图父类创建** ✅ 100% ⭐ 新增

#### 文件列表：
- `SG_GameplayAbility_MeleeAttack.h/cpp` - 近战攻击能力类
- `SG_GameplayAbility_RangedAttack.h/cpp` - 远程攻击能力类

#### 功能说明：
- ✅ 近战攻击能力 C++ 父类
- ✅ 远程攻击能力 C++ 父类
- ✅ 专属配置参数（近战扇形检测、远程预判等）
- ✅ 自动设置攻击类型
- ✅ Blueprint 可配置参数

#### 近战专属配置：
```cpp
// 近战专属参数
int32 MaxTargets = 1;                 // 最大目标数
float AttackAngle = 180.0f;           // 攻击扇形角度
bool bUseConeDetection = true;        // 是否启用扇形检测
```

#### 远程专属配置：
```cpp
// 远程专属参数
FVector ProjectileSpawnOffset = (50, 0, 80);  // 投射物生成偏移
float LeadTargetFactor = 0.5f;                // 目标预判系数
bool bAimAtCenter = true;                     // 是否瞄准身体中心
int32 ProjectileCount = 1;                    // 投射物数量（支持连射）
float ProjectileInterval = 0.1f;              // 连射间隔时间
```

#### C++ 加载路径配置：
```cpp
// 已修改 GrantAttackAbility() 函数
// 近战单位 → /Game/Blueprints/GAS/Abilities/GA_Attack_Melee.GA_Attack_Melee_C
// 远程单位 → /Game/Blueprints/GAS/Abilities/GA_Attack_Ranged.GA_Attack_Ranged_C
```

#### 使用方式：
```
1. 在 UE 编辑器中创建 Blueprint 继承这些类
2. 配置参数（Damage Multiplier、Attack Montage 等）
3. C++ 代码会自动加载并授予能力
```

---

## 🔄 **待完成的模块**

### **优先级1：AI 攻击逻辑** 🔴 ⭐ 下一步

#### 需要做的工作：
1. **创建 StateTree AI Tasks**
   - Task: Find Target（查找最近的敌人）
   - Task: Move To Attack Range（移动到攻击范围）
   - Task: Check Target Valid（检查目标有效性）
   - Task: Perform Attack（执行攻击）
   - Evaluator: Target Distance（目标距离评估器）

2. **创建 StateTree**
   - State: Idle（空闲状态）
   - State: Combat（战斗状态）
     - Sub-State: FindTarget（查找目标）
     - Sub-State: MoveToTarget（移动到目标）
     - Sub-State: Attack（攻击）

3. **创建蓝图资产**
   - GE_Damage_Base（伤害 GameplayEffect）
   - GA_Attack_Melee（近战攻击技能）
   - GA_Attack_Ranged（远程攻击技能）
   - BP_Projectile_Arrow（弓箭投射物）
   - DT_UnitData（单位数据表）

---

### **优先级2：武将技能系统** 🔴

#### 需要实现的技能：
1. **曹操：剑雨**
   - 范围伤害技能
   - 生成多个伤害判定区域

2. **刘备：召唤兵团**
   - 在后方生成随机兵团
   - 使用已有的兵团生成逻辑

---

### **优先级3：计谋卡系统** 🔴

#### 需要实现的计谋：
1. **流木计**
   - 生成滚动的木桩
   - 击中后击退敌人
   - 木桩击中后破碎

2. **火矢计**
   - 从主城射出大量火箭
   - 指定范围伤害

3. **神速计**
   - 全体移速和攻速提升
   - 持续6秒
   - 使用 GameplayEffect 实现

---

### **优先级4：主城弓箭手系统** 🟡

#### 需要做的工作：
1. **扩展 ASG_MainCityBase**
   - 添加弓箭手子Actor数组
   - 实现弓箭手生成逻辑
   - 实现自动攻击逻辑

---

## 📋 **下一步行动计划**

### **第一阶段：基础攻击系统集成（预计2-3小时）**
1. ✅ 修改 ASG_UnitsBase 集成攻击系统 ⭐ 已完成
2. ⏳ 创建 AI 攻击逻辑
3. ⏳ 创建蓝图资产并测试

### **第二阶段：武将技能（预计2小时）**
1. ✅ 实现曹操技能
2. ✅ 实现刘备技能

### **第三阶段：计谋卡（预计3小时）**
1. ✅ 实现流木计
2. ✅ 实现火矢计
3. ✅ 实现神速计

### **第四阶段：主城弓箭手（预计1小时）**
1. ✅ 实现弓箭手系统

---

## 🎯 **技术要点总结**

### **GAS 使用最佳实践**
1. **伤害计算**：使用 Execution Calculation
2. **Buff/Debuff**：使用 Instant/Duration GameplayEffect
3. **技能释放**：使用 GameplayAbility
4. **属性修改**：通过 SetByCaller 传递参数

### **性能优化建议**
1. **对象池**：投射物需要对象池（避免频繁创建销毁）
2. **范围检测**：使用碰撞通道过滤（减少无效检测）
3. **日志级别**：正式发布时关闭 Verbose 日志

### **调试技巧**
1. **日志分类**：使用 LogSGGameplay 分类日志
2. **可视化调试**：在技能中绘制调试球体/射线
3. **蓝图事件**：利用 OnAttackHit、OnHitTarget 蓝图事件

---

## 📞 **需要您的输入**

1. **确认配置值**
   - 单位属性是否符合预期？
   - 伤害倍率是否需要调整？

2. **动画资产**
   - 是否有攻击动画蒙太奇？
   - AnimNotify 是否已添加？

3. **美术资源**
   - 投射物网格体
   - 技能特效
   - 音效资源

---

## 📝 **编译注意事项**

### **需要添加的 GameplayTag**
在项目设置 → GameplayTags 中添加：
```
Data.Damage          // 伤害倍率标签
Ability.Attack       // 攻击技能标签
Unit.Type.Infantry   // 步兵类型标签
Unit.Type.Cavalry    // 骑兵类型标签
Unit.Type.Archer     // 弓兵类型标签
Unit.Faction.Player  // 玩家阵营标签
Unit.Faction.Enemy   // 敌方阵营标签
```

### **编译命令**
```bash
cd /home/user/webapp
# 生成项目文件
/path/to/UnrealBuildTool -projectfiles -project="Sguo.uproject" -game -engine

# 编译项目
/path/to/UnrealBuildTool Sguo Development Linux -Project="Sguo.uproject" -TargetType=Game
```

---

**请告诉我是否需要继续实现下一阶段的内容！**
