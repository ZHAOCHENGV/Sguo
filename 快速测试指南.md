# 战斗系统快速测试指南

## 🚀 快速开始

### 第一步：编译项目
```bash
# 在 UE 编辑器中点击 Compile 按钮
# 或者使用快捷键：Ctrl+Alt+F11
```

---

## 🎯 测试 1：单位初始化测试

### 目的
验证直接拖放到场景的单位是否能正确初始化属性。

### 步骤
1. 打开您的测试关卡
2. 拖放一个 `BP_步兵` 到场景中
3. 运行游戏（PIE）
4. 查看日志输出

### 预期日志
```
LogSGGameplay: Warning: ⚠️ BP_步兵_C_0: 检测到未初始化的单位，执行自动初始化
LogTemp: Log: ============AttributeSet初始化属性开始============
LogTemp: Log:   最大生命值：500 (基础: 500, 倍率: 1.00)
LogTemp: Log:   攻击力：50 (基础: 50, 倍率: 1.00)
LogTemp: Log:   移动速度：400 (基础: 400, 倍率: 1.00)
LogTemp: Log:   攻击速度：1.00 (基础: 1.00, 倍率: 1.00)
LogTemp: Log: ============AttributeSet初始化属性结束============
```

### ✅ 成功标准
- 单位的生命值不再是 0
- 属性值与 Blueprint 中设置的 Base 值一致
- 没有 "❌ AttributeSet 为空" 的错误

---

## 🎯 测试 2：攻击范围可视化测试

### 目的
验证攻击范围和视野可视化系统是否工作。

### 步骤 1：在编辑器中测试
1. 选中场景中的 `BP_步兵`
2. 在 Details 面板中找到 `Debug Visualization` 分类
3. 勾选 `显示攻击范围`（bShowAttackRange）
4. 勾选 `显示视野范围`（bShowVisionRange）
5. 运行游戏（PIE）

### 预期效果
- **红色圆圈**：攻击范围（默认 150 厘米）
- **黄色圆圈**：视野范围（默认 1500 厘米）
- 圆圈随单位移动

### 步骤 2：运行时切换
1. 运行游戏（PIE）
2. 选中单位
3. 在 Details 面板中切换开关
4. 观察圆圈实时显示/隐藏

### 步骤 3：蓝图调用测试（可选）
在蓝图中调用：
- `ToggleAttackRangeVisualization()` - 切换攻击范围显示
- `ToggleVisionRangeVisualization()` - 切换视野范围显示

### ✅ 成功标准
- 能看到红色和黄色的圆圈
- 圆圈大小正确（红色小，黄色大）
- 切换开关时圆圈实时显示/隐藏

---

## 🎯 测试 3：GE_Damage_Base 配置测试

### 目的
验证 GameplayEffect 是否配置正确。

### 步骤 1：检查 GE 配置
1. 打开 `GE_Damage_Base` 蓝图
2. 选择根节点
3. 在 Details 面板中检查：

**检查清单：**
- [ ] **Duration Policy** = `Instant`
- [ ] **Executions** 数组有 1 个元素
  - [ ] **Calculation Class** = `SG_DamageExecutionCalc`
  - [ ] **Calculation Modifiers** 有配置：
    - [ ] Backing Attribute = `AttackDamage`
    - [ ] Attribute Source = `Source`
    - [ ] Snapshot = `false`
- [ ] **Modifiers** 数组为空
- [ ] **SetByCaller Magnitudes** 有配置：
  - [ ] Data Tag = `Data.Damage`

### 步骤 2：GameplayTag 检查
1. 打开 **Project Settings → GameplayTags**
2. 确认已配置 `Data.Damage` tag

### ✅ 成功标准
- 所有配置项都符合要求
- `Data.Damage` tag 已配置

**如果配置有问题，请参考 `GE_Damage_Base配置诊断.md` 文档。**

---

## 🎯 测试 4：近战攻击伤害测试

### 目的
验证近战单位能否对敌人造成伤害。

### 准备工作
1. 确保 GE_Damage_Base 配置正确（参考测试 3）
2. 确保单位已初始化（参考测试 1）

### 步骤
1. 在场景中放置两个步兵：
   - **步兵 A**：阵营设置为 `Unit.Faction.Player`
   - **步兵 B**：阵营设置为 `Unit.Faction.Enemy`
2. 将两个步兵靠近（距离 < 150 厘米）
3. 运行游戏（PIE）
4. 选中步兵 A，手动触发攻击：
   - 在 Details 面板中找到 `Combat` 分类
   - 设置 `Current Target` = 步兵 B
   - 调用 `Perform Attack()` 函数

### 预期日志
```
LogSGGameplay: Verbose: ========== 伤害计算开始 ==========
LogSGGameplay: Verbose:   攻击者：BP_步兵_C_0
LogSGGameplay: Verbose:   攻击力：50.0
LogSGGameplay: Verbose:   伤害倍率：1.00
LogSGGameplay: Verbose:   被攻击者：BP_步兵_C_1
LogSGGameplay: Verbose:   最终伤害：50.0
LogSGGameplay: Log:   ✓ 伤害已应用到 IncomingDamage
LogSGGameplay: Verbose: ========================================
LogSGGameplay: Verbose: BP_步兵_C_1 生命值变化：450.0 / 500.0 (旧值: 500.0)
```

### 观察点
1. **伤害计算日志**：应该看到完整的伤害计算流程
2. **生命值变化**：步兵 B 的生命值应该从 500 减少到 450
3. **没有错误**：不应该看到 "❌ 伤害 GE 应用失败" 的错误

### ✅ 成功标准
- 日志显示 "✓ 伤害已应用到 IncomingDamage"
- 目标的生命值正确减少
- 没有 GE 应用失败的错误

---

## 🎯 测试 5：AI 自动攻击测试（可选）

### 目的
验证 AI 是否能自动查找目标并攻击。

### 前提条件
- StateTree AI 已配置并运行
- 攻击系统已经通过测试 4

### 步骤
1. 在场景中放置两个步兵：
   - 步兵 A：玩家阵营
   - 步兵 B：敌人阵营
2. 确保两个步兵距离较近
3. 运行游戏（PIE）
4. 观察 AI 行为

### 预期行为
- 步兵 A 自动查找最近的敌人（步兵 B）
- 步兵 A 移动到攻击范围内
- 步兵 A 自动发起攻击
- 步兵 B 的生命值持续下降

### ✅ 成功标准
- AI 能自动查找并锁定目标
- AI 能自动移动到攻击范围
- AI 能持续攻击直到目标死亡

---

## 🐛 常见问题排查

### 问题 1：单位血量为 0
**原因**：单位未初始化

**解决方案**：
- 检查是否已编译最新代码
- 查看日志是否有 "⚠️ 检测到未初始化的单位" 警告
- 如果没有警告，可能是 BeginPlay 未执行

### 问题 2：看不到可视化圆圈
**原因**：开关未启用或 Tick 未执行

**解决方案**：
- 确认 `bShowAttackRange` 和 `bShowVisionRange` 已勾选
- 确认 `PrimaryActorTick.bCanEverTick = true`
- 检查是否在运行时（PIE），而不是编辑器中

### 问题 3：GE 应用失败
**原因**：GE 配置错误

**解决方案**：
1. 查看 `GE_Damage_Base配置诊断.md` 文档
2. 重点检查：
   - Duration Policy = Instant
   - Modifiers 数组为空
   - Calculation Modifiers 有正确配置

### 问题 4：攻击没有伤害
**原因**：伤害倍率为 0 或攻击力为 0

**解决方案**：
- 检查单位的 `AttackDamage` 属性（应该 > 0）
- 检查攻击能力的 `DamageMultiplier`（应该 = 1.0）
- 查看日志中的 "伤害倍率" 和 "攻击力"

---

## 📊 测试结果记录

| 测试项 | 状态 | 备注 |
|-------|------|------|
| ✅ 单位初始化 | 通过/失败 | 血量是否正确初始化 |
| ✅ 攻击范围可视化 | 通过/失败 | 圆圈是否正确显示 |
| ✅ GE 配置检查 | 通过/失败 | 配置是否符合要求 |
| ✅ 近战伤害测试 | 通过/失败 | 是否能造成伤害 |
| ✅ AI 自动攻击 | 通过/失败 | AI 是否正常工作 |

---

## 📝 下一步计划

测试完成后，根据结果：

### 如果所有测试通过 ✅
1. 继续实现远程攻击系统
2. 实现英雄技能系统
3. 实现策略卡系统

### 如果有测试失败 ❌
1. 根据错误日志定位问题
2. 参考 `GE_Damage_Base配置诊断.md` 修复 GE 配置
3. 重新测试

---

## 🆘 需要帮助？

如果遇到问题，请提供：
1. 完整的日志输出
2. GE_Damage_Base 的截图
3. 单位的属性值截图
4. 详细的错误描述

我会帮您快速定位并解决问题！
